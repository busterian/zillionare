
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      
      <link rel="shortcut icon" href="../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.1.2, mkdocs-material-6.2.8">
    
    
      
        <title>开发者指南 - www.jieyu.ai</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/main.cb6bc1d0.min.css">
      
        
        <link rel="stylesheet" href="../assets/stylesheets/palette.39b8e14a.min.css">
        
      
    
    
    
      
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700%7CRoboto+Mono&display=fallback">
        <style>body,input{font-family:"Roboto",-apple-system,BlinkMacSystemFont,Helvetica,Arial,sans-serif}code,kbd,pre{font-family:"Roboto Mono",SFMono-Regular,Consolas,Menlo,monospace}</style>
      
    
    
    
    
      
    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="" data-md-color-primary="none" data-md-color-accent="none">
      
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#11-操作系统和ide" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header-nav md-grid" aria-label="Header">
    <a href=".." title="www.jieyu.ai" class="md-header-nav__button md-logo" aria-label="www.jieyu.ai">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 003-3 3 3 0 00-3-3 3 3 0 00-3 3 3 3 0 003 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54z"/></svg>

    </a>
    <label class="md-header-nav__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2z"/></svg>
    </label>
    <div class="md-header-nav__title" data-md-component="header-title">
      <div class="md-header-nav__ellipsis">
        <div class="md-header-nav__topic">
          <span class="md-ellipsis">
            www.jieyu.ai
          </span>
        </div>
        <div class="md-header-nav__topic">
          <span class="md-ellipsis">
            
              开发者指南
            
          </span>
        </div>
      </div>
    </div>
    
      <label class="md-header-nav__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0116 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 019.5 16 6.5 6.5 0 013 9.5 6.5 6.5 0 019.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
      </label>
      
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" data-md-state="active" required>
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0116 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 019.5 16 6.5 6.5 0 013 9.5 6.5 6.5 0 019.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
      </label>
      <button type="reset" class="md-search__icon md-icon" aria-label="Clear" data-md-component="search-reset" tabindex="-1">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41z"/></svg>
      </button>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
  </nav>
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    




<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href=".." title="www.jieyu.ai" class="md-nav__button md-logo" aria-label="www.jieyu.ai">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 003-3 3 3 0 00-3-3 3 3 0 00-3 3 3 3 0 003 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54z"/></svg>

    </a>
    www.jieyu.ai
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href=".." class="md-nav__link">
        简介
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../tutorial/" class="md-nav__link">
        新手教程
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="https://zillionare.readthedocs.io/zh_CN/latest/contributing.html" class="md-nav__link">
        社区
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../history/" class="md-nav__link">
        版本历史
      </a>
    </li>
  

    
      
      
      

  
  
    
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" data-md-toggle="toc" type="checkbox" id="__toc">
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          开发者指南
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        开发者指南
      </a>
      
        
<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#11-操作系统和ide" class="md-nav__link">
    1.1 操作系统和IDE
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#12-虚拟运行环境" class="md-nav__link">
    1.2 虚拟运行环境
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#13-工程模板" class="md-nav__link">
    1.3 工程模板
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#14-文档构建" class="md-nav__link">
    1.4 文档构建
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#21-代码风格" class="md-nav__link">
    2.1 代码风格
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#22-linting" class="md-nav__link">
    2.2 linting
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#31-unittest" class="md-nav__link">
    3.1 unittest
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#32-pytest" class="md-nav__link">
    3.2 pytest
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#33-coverage" class="md-nav__link">
    3.3 coverage
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#34-tox" class="md-nav__link">
    3.4 tox
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#4-开发流程" class="md-nav__link">
    4. 开发流程
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#11-操作系统和ide" class="md-nav__link">
    1.1 操作系统和IDE
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#12-虚拟运行环境" class="md-nav__link">
    1.2 虚拟运行环境
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#13-工程模板" class="md-nav__link">
    1.3 工程模板
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#14-文档构建" class="md-nav__link">
    1.4 文档构建
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#21-代码风格" class="md-nav__link">
    2.1 代码风格
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#22-linting" class="md-nav__link">
    2.2 linting
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#31-unittest" class="md-nav__link">
    3.1 unittest
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#32-pytest" class="md-nav__link">
    3.2 pytest
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#33-coverage" class="md-nav__link">
    3.3 coverage
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#34-tox" class="md-nav__link">
    3.4 tox
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#4-开发流程" class="md-nav__link">
    4. 开发流程
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content">
            <article class="md-content__inner md-typeset">
              
                
                
                  <h1>开发者指南</h1>
                
                <p>=========
开发指南
=========</p>
<p>本文档适用于Zillionare系列项目的协同开发者。</p>
<p>这一章详细讲解了大富翁的开发工具链，多数情况下，我们还讲述了选择这些工具的理由。</p>
<p>如果您参与开发大富翁相关项目，您很可能不需要从头配置这些工具链，因为相关的配置文件都会随代码clone时下载到本地，您只需要运行 <code>pip install -r requirements_dev.txt</code> , 绝大多数工具就完成了配置，只有两个例外：</p>
<ol>
<li>您需要运行 <code>pre-commit install</code> 来完成pre-commit hooks的安装</li>
<li>您需要设置IDE，使之在代码保存时，自动运行lint工具。</li>
</ol>
<p>尽管如此，理解我们为何选择这些工具，各项配置又如何起作用，在多人协作项目中，仍然是十分重要的。所以，我们推荐大富翁的协同开发者在进入开发之前，认真阅读这一章。Zillionare项目尽可能遵循Python工程最佳实践。我们通过采用社区内广泛认可的各种工具来保证实现最佳实践。因此，熟悉了本章的内容，也可以认为就熟练掌握了Python工程最佳实践。</p>
<p>.. hint::</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span>
<span class="normal">4</span>
<span class="normal">5</span>
<span class="normal">6</span></pre></div></td><td class="code"><div class="highlight"><pre><span></span><code>Poetry已经是官方推荐的构建工具。但大富翁项目中并未使用Poetry。
原因有二：

1. Poetry目前（2020年11月）还有较严重的性能 `bug &lt;https://github.com/python-poetry/poetry/issues/2094&gt;`_，在进行依赖解析时，一次运行可以长达半小时或者更久。这个问题可能由多重原因引起，也包括部分问题只出现在中国大陆；所以预期这个问题难以在短时间内完全解决。为避免降低开发效率，目前我们不推荐使用Poetry。

2. 整个社区还没有准备好。Poetry的目标是成为all-in-one的配置工具，但整个社区还需要一定的时间，使得各种依赖包、代码检查工具、测试工具等都准备好。
</code></pre></div>
</td></tr></table>
<ol>
<li>开发环境和工具
`````````````````</li>
</ol>
<p>关于开发环境和工具的使用，可以参考解语科技的博客文章 <code>windows下如何构建Python开发环境 &lt;http://blog.jieyu.ai/blog_2020/%E5%A6%82%E4%BD%95%E6%9E%84%E5%BB%BAPython%E5%BC%80%E5%8F%91%E7%8E%AF%E5%A2%83/&gt;</code>_。</p>
<h3 id="11-操作系统和ide">1.1 操作系统和IDE<a class="headerlink" href="#11-操作系统和ide" title="Permanent link">&para;</a></h3>
<p>项目中使用的库和测试用例，均只保证在Linux下正确和高效运行。因此，推荐使用Windows + Linux的混合式开发环境，或者您可以使用Win10 + WSL的方式进行开发。不推荐使用纯粹的Windows进行开发。</p>
<p>.. csv-table:: 软件清单
    :header: "软件类别","软件","版本","说明"
    :widths: 20, 15, 15, 15</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span>
<span class="normal">4</span>
<span class="normal">5</span>
<span class="normal">6</span>
<span class="normal">7</span>
<span class="normal">8</span>
<span class="normal">9</span></pre></div></td><td class="code"><div class="highlight"><pre><span></span><code>操作系统,Ubuntu/WSL,18.04,
IDE,vscode/pycharm,,pycharm专业版，以便远程调试
运行时,Python,3.8,
内存数据库,Redis,&gt;4.0,
数据库,Postgres,&gt;10,存放市值数据
负载均衡,Nginx,,选装
行情服务,jqdatasdk,&gt;1.8,
日志服务,rsyslog,,在生产环境下使用
容器,docker,,用于模拟生产环境部署
</code></pre></div>
</td></tr></table>
<h3 id="12-虚拟运行环境">1.2 虚拟运行环境<a class="headerlink" href="#12-虚拟运行环境" title="Permanent link">&para;</a></h3>
<p>每一个子项目，都应该在其对应的虚拟环境下运行。比如，开发Omega时，需要新建一个Omega的开发环境，将所有的依赖库均只安装到这个虚拟环境中（并且根据需要添加到setup.py中）。</p>
<p>推荐使用miniconda来构建虚拟环境。但项目中使用tox，所以virtual env也在使用之中。</p>
<h3 id="13-工程模板">1.3 工程模板<a class="headerlink" href="#13-工程模板" title="Permanent link">&para;</a></h3>
<p>创建新的工程时，我们往往有一堆繁琐的搭架子的工作。一些IDE或者应用框架为此提供了相应的开发模板。在大富翁开发中，我们使用 Cookiecutter_ 库来创建新应用的基本框架。Cookiecutter_会为我们生成文档框架(Shpinx构建系统，各种文档模板）、多版本测试（Tox）、CI集成（Travis, code coverage)、版本发布（Twine，pypi等）。要完全从头开始手工配置所有这些工具，并使之协同工作是需要花较多时间的。</p>
<p>Omega, Omicron, Omega-jqadaptor等子项目都是通过 Cookiecutter_ 来创建的。如果需要创建新的子项目，推荐仍使用 Cookiecutter_ 来创建，以保证新的项目有同样的开发发布流程和质量标准。</p>
<p>在Cookiecutter创建模板时，还会指定是否创建Console script，并且推荐使用Click作为命令行工具的开发框架。在大富翁项目中，我们不使用Click，而是使用google出品的fire框架。Fire上手更容易，代码量更少。</p>
<h3 id="14-文档构建">1.4 文档构建<a class="headerlink" href="#14-文档构建" title="Permanent link">&para;</a></h3>
<p>使用reStructuredTxt文档格式，并使用Sphinx来构建。构建的文档发布到 <code>readthedocs &lt;https://readthedocs.org/&gt;</code>_。</p>
<p>对于docstring，约定统一使用 <code>google style &lt;https://sphinxcontrib-napoleon.readthedocs.io/en/latest/example_google.html&gt;</code>_。</p>
<p>我们使用doc8来对文档时行测试。在tox中进行配置，详见本章中tox一节。</p>
<ol>
<li>代码质量
```````````````
大富翁通过约定代码风格、强制代码检查、集成测试、测试覆盖率等手段来保证代码质量。</li>
</ol>
<h3 id="21-代码风格">2.1 代码风格<a class="headerlink" href="#21-代码风格" title="Permanent link">&para;</a></h3>
<ol>
<li>使用空格而不是制表键来实现缩进</li>
<li>缩进大小为4</li>
<li>换行符始终为lf</li>
<li>每行长度最大不超88个字符</li>
</ol>
<p>在大富翁的每一个子项目的根目录里，都有一个.editorconfig文件，用以约定上述规范:</p>
<p>.. code::</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span></pre></div></td><td class="code"><div class="highlight"><pre><span></span><code># .editorconfig

# http://editorconfig.org

root = true

[*]
indent_style = space
indent_size = 4
trim_trailing_whitespace = true
insert_final_newline = true
charset = utf-8
end_of_line = lf

[*.bat]
indent_style = tab
end_of_line = crlf

[LICENSE]
insert_final_newline = false

[Makefile]
indent_style = tab
</code></pre></div>
</td></tr></table>
<p>对于Python文件，我们使用<code>black &lt;https://github.com/psf/black&gt;</code>_ 来强制代码风格。</p>
<h3 id="22-linting">2.2 linting<a class="headerlink" href="#22-linting" title="Permanent link">&para;</a></h3>
<p>大富翁在开发过程中，要求开发者在三个时机都进行代码检查。</p>
<p>第一个时机是保存代码时。需要设置您的IDE在保存代码时自动进行代码检查和格式化。如果您使用vscode，则应该按如下方式设置：</p>
<p>.. code::</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span>
<span class="normal">4</span>
<span class="normal">5</span>
<span class="normal">6</span>
<span class="normal">7</span></pre></div></td><td class="code"><div class="highlight"><pre><span></span><code># settings.json
&quot;editor.codeActionsOnSave&quot;: {
    &quot;source.fixAll&quot;: true,
    &quot;source.sortImports&quot;: true
},
&quot;editor.formatOnPaste&quot;: true,
&quot;editor.formatOnSave&quot;: true,
</code></pre></div>
</td></tr></table>
<p>第二个时机是在提交代码时。大富翁的每一个子项目，都要求设置pre-commit hook：</p>
<p>pre-commit是一个Python库，安装后，您需要运行 <code>pre-commit install</code> 命令，并在工程根目录下放置如下配置文件：</p>
<p>.. code::</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span></pre></div></td><td class="code"><div class="highlight"><pre><span></span><code># .pre-commit-config.yaml
repos:
-   repo: https://github.com/pre-commit/mirrors-isort
    rev: v4.3.21
    hooks:
    - id: isort
    exclude: docs/conf.py
-   repo: https://github.com/ambv/black
    rev: stable
    hooks:
    - id: black
-   repo: https://github.com/pre-commit/pre-commit-hooks
    rev: v2.3.0
    hooks:
    - id: flake8
</code></pre></div>
</td></tr></table>
<p>根据上述配置，每次您在提交代码前，git将自动运行isort, black和flake8。</p>
<p>2.2.1 isort
::::::::::::</p>
<p>isort是一个Python imports整理工具。它执行Python imports段的格式化、以及import的排序。它不能移虽导入、但未使用的import库。</p>
<p>如果您使用vscode，flake8会报告未使用的导入错误，然后您需要手动移除它（不要使用autoflake)_。
如果您使用Pycharm，Pycharm会提示并自动移除import错误。</p>
<p>我们使用工程根目录下的.isort.cfg来配置：</p>
<p>..code::</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span></pre></div></td><td class="code"><div class="highlight"><pre><span></span><code># .isort.cfg
[settings]
    multi_line_output = 3
    include_trailing_comma = True
    force_grid_wrap = 0
    use_parentheses = True
    ensure_newline_before_comments = True
    line_length = 88

    # 不检查docs/下的conf.py，这个文件中有一个不规范的导入，是必须的
    skip_glob = docs/conf.py
</code></pre></div>
</td></tr></table>
<p>2.2.2 black
::::::::::::</p>
<p>black是一个Python代码格式化工具，相比其它代码格式化工具，以其代码风格强制统一、毫不妥协著称。它惟一能配置的选项就是每行最大字符数。在大富翁项目中，我们也使用其默认的88个字符。因此，对于black，无须任何配置即可使用。</p>
<p>2.2.3 flake8
:::::::::::::</p>
<p>大富翁选择flake8作为lint工具，而不使用pylint。在某些方面，pylint甚至表现比flake8更好。但在vscode中进行开发时，如果启用了pylance（推荐使用），pylance也会报一些lint相关的错误，pylint也会在同样位置报告lint错误。如果该错误经确认需要supress，则需要在同一行同时使用两种不同的语法来supress这个错误。而Pylint的语法比较繁琐（虽然更清晰），很容易导致行超长。</p>
<p>另外，pylint报告的错误信息过多，也会一定程度上使程序员陷入各种“纠错”中，但这些错误不见得真的就成为问题，因此影响了开发的效率，收获并不大。</p>
<p>我们通过在工程根目录下放置.flake8文件来进行配置，内容如下（注意有一部分是为了解决与black的兼容性问题）：</p>
<p>.. code::</p>
<p>[flake8]
    # required by black, https://github.com/psf/black/blob/master/.flake8
    max-line-length = 88
    max-complexity = 18
    extend-ignore = E203, E266, E501
    select = B,C,E,F,W,T4,B9
    per-file-ignores =
        <strong>init</strong>.py:F401
    exclude =
        .git,
        <strong>pycache</strong>,
        setup.py,
        build,
        dist,
        releases,
        .venv,
        .tox,
        .mypy_cache,
        .pytest_cache,
        .vscode,
        .github,
        docs/conf.py,
        tests</p>
<p>第三个时机则是在使用tox进行测试时，其配置我们留到tox这一节再讲。</p>
<ol>
<li>测试
````````````
在大富翁中，我们使用这些工具来进行单元测试：</li>
</ol>
<h3 id="31-unittest">3.1 unittest<a class="headerlink" href="#31-unittest" title="Permanent link">&para;</a></h3>
<p>unittest、pytest和nose是Python中常用的单元测试框架。因为unittest是标准库的一部分，所以大富翁使用unittest来写单元测试用例。如果有必要，未来也可能更改为pytest。使用pytest作为测试工具现在更为流行。</p>
<h3 id="32-pytest">3.2 pytest<a class="headerlink" href="#32-pytest" title="Permanent link">&para;</a></h3>
<p>大富翁使用pytest作为单元测试的运行工具。我们一般不单独运行pytest，而是通过tox来调用。</p>
<h3 id="33-coverage">3.3 coverage<a class="headerlink" href="#33-coverage" title="Permanent link">&para;</a></h3>
<p>大富翁使用coverage和py-cov来衡量单元测试的覆盖率。通过在工程根目录下放置.coveragerc文件来实现对其配置：</p>
<p>.. code::</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span></pre></div></td><td class="code"><div class="highlight"><pre><span></span><code># .coveragerc
[run]
omit =
    */config/schema.py
[report]
exclude_lines =
    pragma: no cover
    def __repr__
    if self.debug:
    if settings.DEBUG
    raise AssertionError
    raise NotImplementedError
    if 0:
    if __name__ == .__main__.:
</code></pre></div>
</td></tr></table>
<p>上述配置是大富翁推荐的默认配置。其中config/schema.py是配置的schema文件，由cfg4py自动生成，无须测试。</p>
<h3 id="34-tox">3.4 tox<a class="headerlink" href="#34-tox" title="Permanent link">&para;</a></h3>
<p>大富翁使用 <code>tox &lt;https://tox.readthedocs.io/en/latest/&gt;</code>_ 来管理集成测试。大富翁中使用tox.ini来配置：</p>
<p>.. code::</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span></pre></div></td><td class="code"><div class="highlight"><pre><span></span><code># tox.ini
[tox]
envlist = py38, lint

[travis]
python =
    3.8: py38

[testenv:lint]
basepython = python
deps =
    flake8
    doc8
    black
commands =
    black omega tests
    flake8 omega tests
    doc8 docs

[testenv]
basepython = python
deps =
    pytest
    pytest-cov

setenv =
    PYTHONPATH = {toxinidir}
    PYTHONWARNINGS = ignore
passenv = *

commands =
    pip install -r requirements_dev.txt
    pytest --cov=omega --cov-append --cov-report=term-missing --cov-config \
    .coveragerc tests
</code></pre></div>
</td></tr></table>
<p>上述配置要求在运行tox时，对代码再进行一次检查（见lint一节）。这里请注意我们使用了doc8来对文档进行检查。</p>
<p>配置还要求在使用pytest运行测试时，对代码进行覆盖率检查。通过--cov-conig=.coveragerc来传入配置。</p>
<h3 id="4-开发流程">4. 开发流程<a class="headerlink" href="#4-开发流程" title="Permanent link">&para;</a></h3>
<p>如果您有意愿参与大富翁项目的开发，请从主分支上fork为自己的分支，完成功能开发、单元测试之后，发出merge requst，项目的owner经评估之后，将会及时merge回主分支。</p>
<p>.. _Cookiecutter: https://github.com/audreyr/cookiecutter
.. _Cookiecutter-pypackage: https://github.com/audreyr/cookiecutter-pypackage</p>
                
              
              
                


              
            </article>
          </div>
        </div>
      </main>
      
        
<footer class="md-footer">
  
    <div class="md-footer-nav">
      <nav class="md-footer-nav__inner md-grid" aria-label="Footer">
        
          <a href="../history/" class="md-footer-nav__link md-footer-nav__link--prev" rel="prev">
            <div class="md-footer-nav__button md-icon">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
            </div>
            <div class="md-footer-nav__title">
              <div class="md-ellipsis">
                <span class="md-footer-nav__direction">
                  Previous
                </span>
                版本历史
              </div>
            </div>
          </a>
        
        
      </nav>
    </div>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
        Made with
        <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
          Material for MkDocs
        </a>
      </div>
      
    </div>
  </div>
</footer>
      
    </div>
    
      <script src="../assets/javascripts/vendor.18f0862e.min.js"></script>
      <script src="../assets/javascripts/bundle.994580cf.min.js"></script><script id="__lang" type="application/json">{"clipboard.copy": "Copy to clipboard", "clipboard.copied": "Copied to clipboard", "search.config.lang": "en", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.placeholder": "Search", "search.result.placeholder": "Type to start searching", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.term.missing": "Missing"}</script>
      
      <script>
        app = initialize({
          base: "..",
          features: [],
          search: Object.assign({
            worker: "../assets/javascripts/worker/search.9c0e82ba.min.js"
          }, typeof search !== "undefined" && search)
        })
      </script>
      
    
  </body>
</html>